<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Submission</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase CDN Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBnjBn6sTwnqDjrMXdgmFZ2dugrL5OVLTI",
        authDomain: "news-bias-analyzer.firebaseapp.com",
        projectId: "news-bias-analyzer",
        storageBucket: "news-bias-analyzer.appspot.com",
        messagingSenderId: "661563307465",
        appId: "1:661563307465:web:648bdabecbcf57b0d96418",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const validDomains = [
        'nytimes.com', 'bbc.com', 'cnn.com', 'theguardian.com',
        'reuters.com', 'washingtonpost.com', 'forbes.com',
        'bloomberg.com', 'aljazeera.com', 'npr.org', 'medium.com',
        'hbr.org', 'wired.com', 'theatlantic.com', 'techcrunch.com',
        'businessinsider.com', 'nationalgeographic.com', 'vox.com',
        'economist.com', 'newyorker.com'
      ];

      // Function to validate if the URL is from a valid domain
      function isValidDomain(url) {
        try {
          const domainPattern = /^https?:\/\/(?:[a-z0-9-]+\.)*([a-z0-9-]+\.[a-z]{2,6})(\/|$)/i;
          const domainMatch = url.match(domainPattern);
          if (domainMatch) {
            const domain = domainMatch[1]; 
            return validDomains.includes(domain);
          }
        } catch (error) {
          console.error("Error validating domain:", error);
        }
        return false;
      }

      async function getBiasAnalysis(articleText) {
        const apiKey = "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"; 
        const apiUrl = "https://api-inference.huggingface.co/models/d4data/bias-detection-model";
        
        const headers = {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        };

        const body = {
          inputs: articleText
        };

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(body)
          });
          
          const result = await response.json();
          console.log("Bias analysis result:", result);
          return result;
        } catch (error) {
          console.error("Error in bias analysis API:", error);
          return null;
        }
      }

      // Ensure user is authenticated before allowing article submission
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Logged in user, proceed with article submission
          document.getElementById('submitButton').addEventListener('click', async function(event) {
            event.preventDefault();
            const url = document.getElementById('url').value;
            const errorMessage = document.getElementById('error-message');
            const outputField = document.getElementById('output'); // Output field

            if (!isValidDomain(url)) {
              errorMessage.textContent = 'The article URL must be from a valid news source.';
            } else {
              errorMessage.textContent = '';
              try {
                const articleText = "This is a sample article content for bias analysis."; 
                const biasAnalysisResult = await getBiasAnalysis(articleText);

                if (biasAnalysisResult) {
                  if (biasAnalysisResult.error && biasAnalysisResult.error.includes("loading")) {
                    outputField.textContent = "The model is currently loading. Please try again in a few minutes.";
                  } else {
                    const biasAnalysisString = JSON.stringify(biasAnalysisResult);

                    // Store the URL and bias analysis in the general "Articles" collection
                    await addDoc(collection(db, "Articles"), {
                      article_url: url,
                      submission_date: new Date(),
                      bias_analysis: biasAnalysisString  // Store as a string
                    });

                    // Also store the article in the user's own collection
                    const userArticlesRef = collection(db, `Users/${user.uid}/Articles`);
                    await addDoc(userArticlesRef, {
                      article_url: url,
                      submission_date: new Date(),
                      bias_analysis: biasAnalysisString  // Store as a string
                    });

                    alert('URL successfully submitted and bias analysis stored in Firebase!');

                    // Display result in the output field
                    outputField.textContent = biasAnalysisString;
                  }
                } else {
                  alert('Failed to perform bias analysis. Please try again.');
                }

              } catch (error) {
                console.error("Error adding document:", error);
              }
            }
          });
        } else {
          // If not authenticated, redirect to sign-in page
          window.location.href = 'signin.html';
        }
      });

      // Sign out functionality
      document.getElementById('signOutButton').addEventListener('click', () => {
        signOut(auth).then(() => {
          alert('Signed out successfully!');
          window.location.href = 'signin.html'; // Redirect to sign-in page
        }).catch((error) => {
          console.error('Error during sign-out:', error.message);
        });
      });
    </script>
</head>
<body>
    <!-- Sign Out button at the top right -->
    <div class="top-right">
        <button id="signOutButton">Sign Out</button>
    </div>

    <h1>Submit an Article</h1>
    <div class="submission-container">
      <form id="articleForm">
          <label for="url">Article URL:</label>
          <input type="text" id="url" name="url" placeholder="Enter article URL" required>
          <span id="error-message" class="error"></span>
          <button type="button" id="submitButton">Submit</button>
      </form>
    </div>

    <h2>Bias Analysis Result:</h2>
    <div class="result-container">
        <pre id="output"></pre>
    </div>

</body>
</html>
